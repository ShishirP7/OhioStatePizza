name: Deploy Frontend

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: SSH and Deploy Frontend
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          script: |
            echo "ğŸš€ Starting deployment..."

            APP_DIR="/var/www/ohio-state-client"
            REPO_URL="https://github.com/ShishirP7/OhioStatePizza.git"

            # Ensure base directory exists
            sudo mkdir -p /var/www

            if [ ! -d "$APP_DIR" ]; then
              echo "ğŸ“¦ Cloning repository for first-time setup..."
              git clone $REPO_URL $APP_DIR
            fi

            cd $APP_DIR

            echo "ğŸ”„ Pulling latest changes..."
            git reset --hard
            git pull origin main

            echo "ğŸ“¦ Installing dependencies..."
            npm ci

            echo "âš’ï¸ Building the app..."
            npm run build

            # Check if PM2 is installed
            if ! command -v pm2 &> /dev/null; then
              echo "âš ï¸ PM2 not found. Installing..."
              sudo npm install -g pm2
            fi

            echo "ğŸš€ Starting/restarting PM2 app on port 3005..."
            pm2 restart next-client || PORT=3005 pm2 start "npm run start" --name next-client

            echo "ğŸ§ª Validating and restarting Nginx..."
            sudo nginx -t && sudo systemctl restart nginx

            echo "âœ… Frontend deployed successfully!"
